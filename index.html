<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>&lt;FULLSTAFF & PARTNERS&gt;</title>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500&family=Roboto:wght@400;500&family=Inter:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/main.css">
  <style>
    .main-nav a.active { color: #dc3545; font-weight: 600; }
    .main-nav a.active::after { width: 100%; }
    .show-more-btn {
      margin: 15px auto;
      display: block;
      padding: 10px 20px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      background: #dc3545;
      color: #fff;
      cursor: pointer;
      transition: 0.3s;
    }
    .show-more-btn:hover { background: #a71d2a; }

    /* üü¢ –ß–∞—Ç-—Å—Ç–∏–ª—å –¥–ª—è –ª–µ–Ω—Ç—ã */
    .updates-feed {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .update-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    .update-item .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    .update-bubble {
      background: #fff;
      border: 1px solid #ddd;
      padding: 12px 15px;
      border-radius: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.08);
      max-width: 80%;
      font-size: 14px;
      line-height: 1.5;
    }

    /* üîµ –û—Ç–≤–µ—Ç —Ä–µ–∫—Ä—É—Ç–µ—Ä–∞ ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—É–∑—ã—Ä—å —Å–ø—Ä–∞–≤–∞ */
    .answer {
      align-self: flex-end;
      background: #2196f3;
      color: #fff;
      padding: 10px 14px;
      border-radius: 12px;
      max-width: 70%;
      font-size: 13px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }

    /* –§–æ—Ä–º–∞ –æ—Ç–≤–µ—Ç–∞ */
    .answer-form {
      display: flex;
      gap: 6px;
      margin-top: 10px;
    }
    .answer-form input {
      flex: 1;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 13px;
    }
    .answer-form button {
      padding: 6px 12px;
      background: #dc3545;
      border: none;
      border-radius: 6px;
      color: #fff;
      font-size: 13px;
      cursor: pointer;
      transition: 0.3s;
    }
    .answer-form button:hover { background: #a71d2a; }
  </style>
</head>

<body>
  <!-- –•–µ–¥–µ—Ä -->
  <header>
    <div class="container header-inner">
      <div class="logo">&lt;/vacancy&gt;</div>
      <div class="social-icons">
        <a href="https://t.me/Serhii_Riabovol" target="_blank"><i class="fab fa-telegram"></i></a>
        <a href="mailto:serhii.riabovol@fullstaff.net" target="_blank"><i class="fas fa-envelope"></i></a>
        <a href="https://linkedin.com/in/serhii-riabovol-245b11298" target="_blank"><i class="fab fa-linkedin"></i></a>
        <a href="https://wa.me/48793379163" target="_blank"><i class="fab fa-whatsapp"></i></a>
      </div>
    </div>
  </header>

  <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
  <main class="container">
    <h1>
      <a href="/index.html" style="text-decoration:none; color:inherit;">
        &lt;FULLSTAFF & PARTNERS&gt;
      </a>
    </h1>

    <div class="top-controls">
      <span id="user-name"></span>
      <nav class="main-nav" style="display:none;">
        <a href="/upload/index.html">Upload CV</a>
        <a href="#">My vacancies</a>
        <a href="/pipeline/index.html">Pipeline</a>
        <a href="#">Tasks</a>
      </nav>
      <button class="logout-btn" onclick="logout()" style="display:none;">–í—ã–π—Ç–∏</button>
    </div>

    <!-- –õ–æ–≥–∏–Ω -->
    <div id="login" class="login-box">
      <h3>–í—Ö–æ–¥</h3>
      <input type="text" id="username" placeholder="–õ–æ–≥–∏–Ω"><br>
      <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å"><br>
      <button onclick="login()">–í–æ–π—Ç–∏</button>
    </div>

    <!-- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
    <div id="app" style="display:none;">
      <!-- üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
      <div id="stats" class="stats-grid"></div>
      <!-- üì∞ –õ–µ–Ω—Ç–∞ -->
      <div id="content"></div>
    </div>
  </main>

  <!-- –§—É—Ç–µ—Ä -->
  <footer class="container">
    <p>¬© 2025 FullStaff ¬∑ 
      <a href="mailto:serhii.riabovol@fullstaff.net">serhii.riabovol@fullstaff.net</a> ¬∑ 
      <a href="tel:+48793379163">+48 793 379 163</a>
    </p>
  </footer>
  <div class="footer-gap"></div>

  <!-- –°–∫—Ä–∏–ø—Ç—ã -->
  <script>
    async function hash(str) {
      const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, "0")).join("");
    }

    const users = {
      "rdy07": { passwordHash: "29abebdeaec524b5b1f40c7bc86cc046020ea42150496404382dea6a5a71c2f3", role: "admin", name: null },
      "Serhii Riabovol": { passwordHash: "e6c3da5b206634d7f3f3586d747ffdb36b5c675757b380c6a5fe5c570c714349", role: "user", name: "Serhii Riabovol" },
      "Anna Ivanova": { passwordHash: "1ba3d16e9881959f8c9a9762854f72c6e6321cdd44358a10a4e939033117eab9", role: "user", name: "Anna Ivanova" },
      "Oleg Petrov": { passwordHash: "3acb59306ef6e660cf832d1d34c4fba3d88d616f0bb5c2a9e0f82d18ef6fc167", role: "user", name: "Oleg Petrov" },
      "Marina Kozlova": { passwordHash: "347571be3263ef42336c505a6a43035bb5a2ac89de00d4f61dcaefe87c1b6f63", role: "user", name: "Marina Kozlova" },
      "Dmitry Sokolov": { passwordHash: "1f11d5d72bcc0c7b06dd69b0182b32a9548239cfbe8f9c8236f3946240127b42", role: "user", name: "Dmitry Sokolov" }
    };

    let currentUser = null;
    const avatar = "https://cojo.ru/wp-content/uploads/2022/12/krutoi-kot-4-1.webp"; // üîπ –ø—É—Ç—å –∫ –∞–≤–∞—Ç–∞—Ä–∫–µ –∞–¥–º–∏–Ω–∞

    async function login() {
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();

      if (users[username]) {
        const hashPass = await hash(password);
        if (hashPass === users[username].passwordHash) {
          currentUser = users[username];
          localStorage.setItem("loggedUser", username);

          document.getElementById("login").style.display = "none";
          document.getElementById("app").style.display = "block";
          document.querySelector(".logout-btn").style.display = "inline-block";
          document.querySelector(".main-nav").style.display = "flex";
          document.getElementById("user-name").style.display = "block";
          document.getElementById("user-name").innerText = currentUser.name || username;

          loadUpdates(); 
          return;
        }
      }
      alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å");
    }

    function logout() {
      currentUser = null;
      localStorage.removeItem("loggedUser");
      document.getElementById("login").style.display = "block";
      document.getElementById("app").style.display = "none";
      document.getElementById("stats").innerHTML = "";
      document.getElementById("content").innerHTML = "<p>–ó–¥–µ—Å—å –±—É–¥–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã</p>";
      document.querySelector(".logout-btn").style.display = "none";
      document.querySelector(".main-nav").style.display = "none";
      document.getElementById("user-name").style.display = "none";
      document.getElementById("user-name").innerText = "";
    }

    window.onload = function () {
      const savedUser = localStorage.getItem("loggedUser");
      if (savedUser && users[savedUser]) {
        currentUser = users[savedUser];
        document.getElementById("login").style.display = "none";
        document.getElementById("app").style.display = "block";
        document.querySelector(".logout-btn").style.display = "inline-block";
        document.querySelector(".main-nav").style.display = "flex";
        document.getElementById("user-name").style.display = "block";
        document.getElementById("user-name").innerText = currentUser.name || savedUser;
        loadUpdates();
      }
    };

    async function loadUpdates() {
      try {
        const res = await fetch("https://docs.google.com/spreadsheets/d/1PrAj8rfZRVUtmDRcnoZyBysWdrNih5OYgna7MuPH4mE/gviz/tq?tqx=out:json");
        const text = await res.text();
        const json = JSON.parse(text.substr(47).slice(0, -2));
        const rows = json.table.rows.reverse();

        let uploaded = 0, interview = 0, offer = 0;
        for (let r of rows) {
          const cells = r.c;
          if (!cells[3] || !cells[3].v) continue;
          const recruiter = cells[1]?.v || "";
          const status = cells[12]?.v || "";
          if (currentUser.role !== "admin" && recruiter !== currentUser.name) continue;
          uploaded++;
          if (status.includes("–ò–Ω—Ç–µ—Ä–≤—å—é")) interview++;
          if (status.includes("–û—Ñ—Ñ–µ—Ä")) offer++;
        }

        const interviewRate = uploaded ? Math.round((interview / uploaded) * 100) : 0;
        const offerFromInterview = interview ? Math.round((offer / interview) * 100) : 0;
        const offerRate = uploaded ? Math.round((offer / uploaded) * 100) : 0;

        document.getElementById("stats").innerHTML = `
          <div class="stat-card stat-cv"><h2>${uploaded}</h2><p>Uploaded CVs</p></div>
          <div class="stat-card stat-interview"><h2>${interview}</h2><p>Interviews</p></div>
          <div class="stat-card stat-offer"><h2>${offer}</h2><p>Offers</p></div>
          <div class="stat-card stat-rate"><h2>${interviewRate}%</h2><p>Interview rate</p></div>
          <div class="stat-card stat-rate"><h2>${offerFromInterview}%</h2><p>Offer from interview</p></div>
          <div class="stat-card stat-rate"><h2>${offerRate}%</h2><p>Offer rate</p></div>
        `;

        let updates = [];
        for (let r of rows) {
          const cells = r.c;
          if (!cells[3] || !cells[3].v) continue;
          const recruiter = cells[1]?.v || "";
          const candidate = cells[3]?.v || "";
          const status = cells[12]?.v || "";
          const comment = cells[13]?.v || "";
          const answer = cells[14]?.v || "";
          if (currentUser.role !== "admin" && recruiter !== currentUser.name) continue;

          let statusClass = "";
          if (status.includes("–ù–æ–≤—ã–π")) statusClass = "new";
          if (status.includes("–ü–µ—Ä–µ–¥–∞–Ω")) statusClass = "sent";
          if (status.includes("–ò–Ω—Ç–µ—Ä–≤—å—é")) statusClass = "interview";
          if (status.includes("–û—Ñ—Ñ–µ—Ä")) statusClass = "offer";
          if (status.includes("–û—Ç–∫–∞–∑")) statusClass = "reject";

          let block = `
            <div class="update-item">
              <img src="${avatar}" class="avatar" alt="Admin">
              <div class="update-bubble">
                <b>${candidate}</b>
                ${status ? `<p>–°—Ç–∞—Ç—É—Å: <span class="status ${statusClass}">${status}</span></p>` : ""}
                ${comment ? `<p>üí¨ ${comment}</p>` : ""}
                ${
                  answer 
                  ? `<div class="answer">–í–∞—à –æ—Ç–≤–µ—Ç: ${answer}</div>` 
                  : comment 
                    ? `<form class="answer-form" data-candidate="${candidate}">
                         <input type="text" name="answer" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç..." required>
                         <button type="submit">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
                       </form>`
                    : ""
                }
              </div>
            </div>
          `;
          updates.unshift(block);
        }

        let visibleCount = 10;
        function renderUpdates() {
          let html = "<div class='updates-feed'>";
          html += updates.slice(0, visibleCount).join("");
          html += "</div>";
          if (updates.length > visibleCount) {
            html += `<button id="showMore" class="show-more-btn">Show more</button>`;
          }
          document.getElementById("content").innerHTML = html;

          const btn = document.getElementById("showMore");
          if (btn) {
            btn.addEventListener("click", () => {
              visibleCount += 10;
              renderUpdates();
            });
          }

          document.querySelectorAll(".answer-form").forEach(form => {
            form.addEventListener("submit", async (e) => {
              e.preventDefault();
              const candidate = form.getAttribute("data-candidate");
              const answer = form.querySelector("input[name='answer']").value;
              const button = form.querySelector("button");

              const loader = document.createElement("div");
              loader.className = "spinner-wrap";
              loader.innerHTML = `<div class="spinner"></div> <span>–û—Ç–ø—Ä–∞–≤–∫–∞...</span>`;
              form.appendChild(loader);
              button.disabled = true;

              const payload = { action: "answer", recruiter: currentUser.name, candidate, answer };

              try {
                const res = await fetch("https://script.google.com/macros/s/AKfycbztPneKvfBlRSwOmUiYEysa2CnycHhU9b5R25-7ai5UyaytxJLs7yduH4XDAgqOPIu_/exec", {
                  method: "POST",
                  body: JSON.stringify(payload)
                });

                const result = await res.json();
                if (result.status === "ok") {
                  form.outerHTML = `<div class="answer">–í–∞—à –æ—Ç–≤–µ—Ç: ${answer}</div>`;
                } else {
                  loader.innerHTML = "‚ùå –û—à–∏–±–∫–∞: " + result.message;
                  button.disabled = false;
                }
              } catch (err) {
                loader.innerHTML = "‚ùå –°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞";
                button.disabled = false;
              }
            });
          });
        }
        renderUpdates();
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ loadUpdates:", err);
        document.getElementById("content").innerHTML = "<p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</p>";
      }
    }
  </script>
</body>
</html>
